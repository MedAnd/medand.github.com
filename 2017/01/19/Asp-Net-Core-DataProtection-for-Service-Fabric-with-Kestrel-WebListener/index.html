<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <title>ASP.NET Core DataProtection for Service Fabric with Kestrel &amp; WebListener - Medic Consulting</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="In ASP.NET 1.x - 4.x, if you deployed your application to a Web farm, you had to ensure that the configuration files on each server shared the same value for validationKey and decryptionKey, which wer">
<meta property="og:type" content="article">
<meta property="og:title" content="ASP.NET Core DataProtection for Service Fabric with Kestrel & WebListener">
<meta property="og:url" content="http://www.medic-consulting.com/2017/01/19/Asp-Net-Core-DataProtection-for-Service-Fabric-with-Kestrel-WebListener/index.html">
<meta property="og:site_name" content="Medic Consulting">
<meta property="og:description" content="In ASP.NET 1.x - 4.x, if you deployed your application to a Web farm, you had to ensure that the configuration files on each server shared the same value for validationKey and decryptionKey, which wer">
<meta property="og:image" content="http://www.medic-consulting.com/images/007_AspNetCoreDataProtectionServiceFabricSwaggerAPI.jpg">
<meta property="og:updated_time" content="2017-02-21T08:13:30.962Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="ASP.NET Core DataProtection for Service Fabric with Kestrel & WebListener">
<meta name="twitter:description" content="In ASP.NET 1.x - 4.x, if you deployed your application to a Web farm, you had to ensure that the configuration files on each server shared the same value for validationKey and decryptionKey, which wer">
<meta name="twitter:image" content="http://www.medic-consulting.com/images/007_AspNetCoreDataProtectionServiceFabricSwaggerAPI.jpg">
  
  
    <link rel="icon" href="/favicon.png">
  
  <link href="/webfonts/ptserif/main.css" rel='stylesheet' type='text/css'>
  <link href="/webfonts/source-code-pro/main.css" rel="stylesheet" type="text/css">
  <link href="http://maxcdn.bootstrapcdn.com/font-awesome/latest/css/font-awesome.min.css" rel="stylesheet" type="text/css">
  <link rel="stylesheet" href="/css/style.css">
  
<!-- Google Analytics -->
<script type="text/javascript">
(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','//www.google-analytics.com/analytics.js','ga');

ga('create', 'UA-56342083-1', 'auto');
ga('send', 'pageview');

</script>
<!-- End Google Analytics -->


</head>

<body>
  <div id="container">
    <header id="header">
  <div id="header-outer" class="outer">
    <div id="header-inner" class="inner">
      <a id="main-nav-toggle" class="nav-icon" href="javascript:;"></a>
      <a id="logo" class="logo" href="/"></a>
      <nav id="main-nav">
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
          <a class="main-nav-link" href="/tags">Tags</a>
        
          <a class="main-nav-link" href="/about">About</a>
        
          <a id="social-nav" href="https://www.linkedin.com/profile/view?id=AAEAAADJd3wBQV-OhfBUuu3GZdhCZ8oa_9g462M"><i class="fa fa-linkedin-square" aria-hidden="true"></i></a>
          <a id="social-nav" href="https://github.com/medand"><i class="fa fa-github" aria-hidden="true"></i></a>
          <a id="social-nav" href="/atom.xml"><i class="fa fa-rss" aria-hidden="true"></i></a>
      </nav>
      <nav id="sub-nav">
        <div id="search-form-wrap">
          <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" results="0" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="http://www.medic-consulting.com"></form>
        </div>
      </nav>
    </div>
  </div>
</header>
    <section id="main" class="outer"><article id="post-Asp-Net-Core-DataProtection-for-Service-Fabric-with-Kestrel-WebListener" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 class="article-title" itemprop="name">
      ASP.NET Core DataProtection for Service Fabric with Kestrel &amp; WebListener
    </h1>
  

      </header>
    
    <div class="article-meta">
      <a href="/2017/01/19/Asp-Net-Core-DataProtection-for-Service-Fabric-with-Kestrel-WebListener/" class="article-date">
  <time datetime="2017-01-18T13:13:00.000Z" itemprop="datePublished">2017-01-19</time>
</a>
      
      
    </div>
    <div class="article-entry" itemprop="articleBody">
      
        <p>In ASP.NET 1.x - 4.x, if you deployed your application to a Web farm, you had to ensure that the configuration files on each server shared the same value for validationKey and decryptionKey, which were used for hashing and decryption respectively. In ASP.NET Core this is accomplished via the data protection stack which was designed to address many of the shortcomings of the old cryptographic stack. The new API provides a simple, easy to use mechanism for data encryption, decryption, key management and rotation. The data protection system ships with several in-box key storage providers; File system, Registry, AzureStorage and Redis. </p>
<p>Since we are working with low-latency microservices at massive scale via Azure Service Fabric, in this blog post we’ll describe an approach to create a custom ASP.NET Core data protection key repository using Service Fabric’s built in Reliable Collections, which are Replicated, Persisted, Asynchronous and Transactional. </p>
<p>Previous readers will note we’ve covered how to integrate ASP.Net Core and Kestrel into Service Fabric, moreover how to create Service Fabric microservices in the new .Net Core xproj structure (soon to be superseded with VS 2017), therefore we’ll jump straight into building the AspNetCore.DataProtection.ServiceFabric microservice (warning this post is code heavy). To test everything out we’ll create a sample ASP.Net Core Web API microservice and finally for completeness integrate WebListener, a Windows only web server.</p>
<p>To begin, we create a new stateful Service Fabric microservice called DataProtectionService: </p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> Microsoft.ServiceFabric.Data;</span><br><span class="line"><span class="keyword">using</span> Microsoft.ServiceFabric.Data.Collections;</span><br><span class="line"><span class="keyword">using</span> Microsoft.ServiceFabric.Services.Communication.Runtime;</span><br><span class="line"><span class="keyword">using</span> Microsoft.ServiceFabric.Services.Remoting.Runtime;</span><br><span class="line"><span class="keyword">using</span> Microsoft.ServiceFabric.Services.Runtime;</span><br><span class="line"><span class="keyword">using</span> System;</span><br><span class="line"><span class="keyword">using</span> System.Collections.Generic;</span><br><span class="line"><span class="keyword">using</span> System.Fabric;</span><br><span class="line"><span class="keyword">using</span> System.Threading;</span><br><span class="line"><span class="keyword">using</span> System.Threading.Tasks;</span><br><span class="line"><span class="keyword">using</span> System.Xml.Linq;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">AspNetCore.DataProtection.ServiceFabric</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">internal</span> <span class="keyword">sealed</span> <span class="keyword">class</span> <span class="title">DataProtectionService</span> : <span class="title">StatefulService</span>, <span class="title">IDataProtectionService</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">DataProtectionService</span>(<span class="params">StatefulServiceContext context, IReliableStateManager stateManager</span>) : <span class="title">base</span>(<span class="params">context, stateManager <span class="keyword">as</span> IReliableStateManagerReplica</span>)</span><br><span class="line">        </span>&#123;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">protected</span> <span class="keyword">override</span> IEnumerable&lt;ServiceReplicaListener&gt; <span class="title">CreateServiceReplicaListeners</span>(<span class="params"></span>)</span><br><span class="line">        </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span>[]</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">new</span> ServiceReplicaListener(context =&gt; <span class="keyword">this</span>.CreateServiceRemotingListener(context))</span><br><span class="line">            &#125;;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">async</span> Task&lt;List&lt;XElement&gt;&gt; GetAllDataProtectionElements()</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">var</span> elements = <span class="keyword">new</span> List&lt;XElement&gt;();</span><br><span class="line"></span><br><span class="line">            <span class="keyword">var</span> dictionary = <span class="keyword">await</span> <span class="keyword">this</span>.StateManager.GetOrAddAsync&lt;IReliableDictionary&lt;Guid, XElement&gt;&gt;(<span class="string">"AspNetCore.DataProtection"</span>);</span><br><span class="line">            <span class="keyword">using</span> (<span class="keyword">var</span> tx = <span class="keyword">this</span>.StateManager.CreateTransaction())</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">var</span> enumerable = <span class="keyword">await</span> dictionary.CreateEnumerableAsync(tx);</span><br><span class="line">                <span class="keyword">var</span> enumerator = enumerable.GetAsyncEnumerator();</span><br><span class="line">                <span class="keyword">var</span> token = <span class="keyword">new</span> CancellationToken();</span><br><span class="line"></span><br><span class="line">                <span class="keyword">while</span> (<span class="keyword">await</span> enumerator.MoveNextAsync(token))</span><br><span class="line">                &#123;</span><br><span class="line">                    elements.Add(enumerator.Current.Value);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> elements;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">async</span> Task&lt;XElement&gt; <span class="title">AddDataProtectionElement</span>(<span class="params">XElement element</span>)</span><br><span class="line">        </span>&#123;</span><br><span class="line">            Guid id = Guid.Parse(element.Attribute(<span class="string">"id"</span>).Value);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">var</span> dictionary = <span class="keyword">await</span> <span class="keyword">this</span>.StateManager.GetOrAddAsync&lt;IReliableDictionary&lt;Guid, XElement&gt;&gt;(<span class="string">"AspNetCore.DataProtection"</span>);</span><br><span class="line">            <span class="keyword">using</span> (<span class="keyword">var</span> tx = <span class="keyword">this</span>.StateManager.CreateTransaction())</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">var</span> result = <span class="keyword">await</span> dictionary.GetOrAddAsync(tx, id, element);</span><br><span class="line">                <span class="keyword">await</span> tx.CommitAsync();</span><br><span class="line"></span><br><span class="line">                <span class="keyword">return</span> result;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Congratulations you’ve just implemented a custom key storage provider using a Service Fabric Reliable Dictionary! To integrate with ASP.Net Core Data Protection API we need to also create a ServiceFabricXmlRepository class which implements IXmlRepository. In a new stateless microservice called ServiceFabric.DataProtection.Web create ServiceFabricXmlRepository:</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> AspNetCore.DataProtection.ServiceFabric;</span><br><span class="line"><span class="keyword">using</span> Microsoft.AspNetCore.DataProtection.Repositories;</span><br><span class="line"><span class="keyword">using</span> Microsoft.ServiceFabric.Services.Client;</span><br><span class="line"><span class="keyword">using</span> Microsoft.ServiceFabric.Services.Remoting.Client;</span><br><span class="line"><span class="keyword">using</span> System;</span><br><span class="line"><span class="keyword">using</span> System.Collections.Generic;</span><br><span class="line"><span class="keyword">using</span> System.Xml.Linq;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">ServiceFabric.DataProtection.Web</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">ServiceFabricXmlRepository</span> : <span class="title">IXmlRepository</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> IReadOnlyCollection&lt;XElement&gt; <span class="title">GetAllElements</span>(<span class="params"></span>)</span><br><span class="line">        </span>&#123;</span><br><span class="line">            <span class="keyword">var</span> proxy = ServiceProxy.Create&lt;IDataProtectionService&gt;(<span class="keyword">new</span> Uri(<span class="string">"fabric:/ServiceFabric.DataProtection/DataProtectionService"</span>), <span class="keyword">new</span> ServicePartitionKey());</span><br><span class="line">            <span class="keyword">return</span> proxy.GetAllDataProtectionElements().Result.AsReadOnly();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">StoreElement</span>(<span class="params">XElement element, <span class="keyword">string</span> friendlyName</span>)</span><br><span class="line">        </span>&#123;</span><br><span class="line">            <span class="keyword">if</span> (element == <span class="literal">null</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> ArgumentNullException(<span class="keyword">nameof</span>(element));</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">var</span> proxy = ServiceProxy.Create&lt;IDataProtectionService&gt;(<span class="keyword">new</span> Uri(<span class="string">"fabric:/ServiceFabric.DataProtection/DataProtectionService"</span>), <span class="keyword">new</span> ServicePartitionKey());</span><br><span class="line">            proxy.AddDataProtectionElement(element).Wait();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>To easily bootstrap our custom ServiceFabricXmlRepository into ASP.Net Core on start-up, create the following DataProtectionBuilderExtensions class:</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> Microsoft.AspNetCore.DataProtection;</span><br><span class="line"><span class="keyword">using</span> Microsoft.AspNetCore.DataProtection.Repositories;</span><br><span class="line"><span class="keyword">using</span> Microsoft.Extensions.DependencyInjection;</span><br><span class="line"><span class="keyword">using</span> System;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">ServiceFabric.DataProtection.Web</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title">DataProtectionBuilderExtensions</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> IDataProtectionBuilder <span class="title">PersistKeysToServiceFabric</span>(<span class="params"><span class="keyword">this</span> IDataProtectionBuilder builder</span>)</span><br><span class="line">        </span>&#123;</span><br><span class="line">            <span class="keyword">if</span> (builder == <span class="literal">null</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> ArgumentNullException(<span class="keyword">nameof</span>(builder));</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> builder.Use(ServiceDescriptor.Singleton&lt;IXmlRepository&gt;(services =&gt; <span class="keyword">new</span> ServiceFabricXmlRepository()));</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> IDataProtectionBuilder <span class="title">Use</span>(<span class="params"><span class="keyword">this</span> IDataProtectionBuilder builder, ServiceDescriptor descriptor</span>)</span><br><span class="line">        </span>&#123;</span><br><span class="line">            <span class="keyword">if</span> (builder == <span class="literal">null</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> ArgumentNullException(<span class="keyword">nameof</span>(builder));</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (descriptor == <span class="literal">null</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> ArgumentNullException(<span class="keyword">nameof</span>(descriptor));</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = builder.Services.Count - <span class="number">1</span>; i &gt;= <span class="number">0</span>; i--)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">if</span> (builder.Services[i]?.ServiceType == descriptor.ServiceType)</span><br><span class="line">                &#123;</span><br><span class="line">                    builder.Services.RemoveAt(i);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            builder.Services.Add(descriptor);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> builder;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Building upon previous articles detailing how to integrate Kestrel and Service Fabric, we extend WebHostBuilderHelper to also support the WebListener webserver:</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> Microsoft.AspNetCore.Hosting;</span><br><span class="line"><span class="keyword">using</span> Microsoft.Net.Http.Server;</span><br><span class="line"><span class="keyword">using</span> System.Fabric;</span><br><span class="line"><span class="keyword">using</span> System.IO;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">ServiceFabric.DataProtection.Web</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">internal</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title">WebHostBuilderHelper</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> IWebHost <span class="title">GetServiceFabricWebHost</span>(<span class="params">ServerType serverType</span>)</span><br><span class="line">        </span>&#123;</span><br><span class="line">            <span class="keyword">var</span> endpoint = FabricRuntime.GetActivationContext().GetEndpoint(<span class="string">"ServiceEndpoint"</span>);</span><br><span class="line">            <span class="keyword">string</span> serverUrl = <span class="string">$"<span class="subst">&#123;endpoint.Protocol&#125;</span>://<span class="subst">&#123;FabricRuntime.GetNodeContext().IPAddressOrFQDN&#125;</span>:<span class="subst">&#123;endpoint.Port&#125;</span>"</span>;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> GetWebHost(endpoint.Protocol.ToString(), endpoint.Port.ToString(), serverType);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> IWebHost <span class="title">GetWebHost</span>(<span class="params"><span class="keyword">string</span> protocol, <span class="keyword">string</span> port, ServerType serverType</span>)</span><br><span class="line">        </span>&#123;</span><br><span class="line">            <span class="keyword">switch</span> (serverType)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">case</span> ServerType.WebListener:</span><br><span class="line">                    &#123;</span><br><span class="line">                        IWebHostBuilder webHostBuilder = <span class="keyword">new</span> WebHostBuilder()</span><br><span class="line">                            .UseWebListener(options =&gt;</span><br><span class="line">                            &#123;</span><br><span class="line">                                options.ListenerSettings.Authentication.Schemes = AuthenticationSchemes.None;</span><br><span class="line">                                options.ListenerSettings.Authentication.AllowAnonymous = <span class="literal">true</span>;</span><br><span class="line">                            &#125;);</span><br><span class="line"></span><br><span class="line">                        <span class="keyword">return</span> ConfigureWebHostBuilder(webHostBuilder, protocol, port);</span><br><span class="line">                    &#125;</span><br><span class="line">                <span class="keyword">case</span> ServerType.Kestrel:</span><br><span class="line">                    &#123;</span><br><span class="line">                        IWebHostBuilder webHostBuilder = <span class="keyword">new</span> WebHostBuilder();</span><br><span class="line">                        webHostBuilder.UseKestrel();</span><br><span class="line"></span><br><span class="line">                        <span class="keyword">return</span> ConfigureWebHostBuilder(webHostBuilder, protocol, port);</span><br><span class="line">                    &#125;</span><br><span class="line">                <span class="keyword">default</span>:</span><br><span class="line">                    <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">static</span> IWebHost <span class="title">ConfigureWebHostBuilder</span>(<span class="params">IWebHostBuilder webHostBuilder, <span class="keyword">string</span> protocol, <span class="keyword">string</span> port</span>)</span><br><span class="line">        </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> webHostBuilder</span><br><span class="line">                .UseContentRoot(Directory.GetCurrentDirectory())</span><br><span class="line">                .UseWebRoot(Path.Combine(Directory.GetCurrentDirectory(), <span class="string">"wwwroot"</span>))</span><br><span class="line">                .UseStartup&lt;Startup&gt;()</span><br><span class="line">                .UseUrls(<span class="string">$"<span class="subst">&#123;protocol&#125;</span>://+:<span class="subst">&#123;port&#125;</span>"</span>)</span><br><span class="line">                .Build();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">enum</span> ServerType</span><br><span class="line">    &#123;</span><br><span class="line">        Kestrel,</span><br><span class="line">        WebListener</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Your Web microservice should look something like:</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> Microsoft.ServiceFabric.Services.Communication.AspNetCore;</span><br><span class="line"><span class="keyword">using</span> Microsoft.ServiceFabric.Services.Communication.Runtime;</span><br><span class="line"><span class="keyword">using</span> Microsoft.ServiceFabric.Services.Runtime;</span><br><span class="line"><span class="keyword">using</span> System.Collections.Generic;</span><br><span class="line"><span class="keyword">using</span> System.Fabric;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">ServiceFabric.DataProtection.Web</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">internal</span> <span class="keyword">sealed</span> <span class="keyword">class</span> <span class="title">WebService</span> : <span class="title">StatelessService</span></span><br><span class="line">    &#123;</span><br><span class="line">        ServerType _serverType;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">WebService</span>(<span class="params">StatelessServiceContext context, ServerType serverType</span>)</span><br><span class="line">            : <span class="title">base</span>(<span class="params">context</span>)</span><br><span class="line">        </span>&#123;</span><br><span class="line">            _serverType = serverType;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">protected</span> <span class="keyword">override</span> IEnumerable&lt;ServiceInstanceListener&gt; <span class="title">CreateServiceInstanceListeners</span>(<span class="params"></span>)</span><br><span class="line">        </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> ServiceInstanceListener[]</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">new</span> ServiceInstanceListener(serviceContext =&gt;</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="keyword">switch</span> (_serverType)</span><br><span class="line">                    &#123;</span><br><span class="line">                        <span class="keyword">case</span> ServerType.WebListener :</span><br><span class="line">                            &#123;</span><br><span class="line">                                <span class="keyword">return</span> <span class="keyword">new</span> WebListenerCommunicationListener(serviceContext, <span class="string">"ServiceEndpoint"</span>, url =&gt;</span><br><span class="line">                                &#123;</span><br><span class="line">                                    <span class="keyword">return</span> WebHostBuilderHelper.GetServiceFabricWebHost(_serverType);</span><br><span class="line">                                &#125;);</span><br><span class="line">                            &#125;</span><br><span class="line">                        <span class="keyword">case</span> ServerType.Kestrel:</span><br><span class="line">                            &#123;</span><br><span class="line">                                <span class="keyword">return</span> <span class="keyword">new</span> KestrelCommunicationListener(serviceContext, <span class="string">"ServiceEndpoint"</span>, url =&gt;</span><br><span class="line">                                &#123;</span><br><span class="line">                                    <span class="keyword">return</span> WebHostBuilderHelper.GetServiceFabricWebHost(_serverType);</span><br><span class="line">                                &#125;);</span><br><span class="line">                            &#125;</span><br><span class="line">                        <span class="keyword">default</span>:</span><br><span class="line">                            <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;)                  </span><br><span class="line">            &#125;;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Next modify Program.cs with below code:</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> CommandLine;</span><br><span class="line"><span class="keyword">using</span> Microsoft.AspNetCore.Hosting;</span><br><span class="line"><span class="keyword">using</span> Microsoft.ServiceFabric.Services.Runtime;</span><br><span class="line"><span class="keyword">using</span> System;</span><br><span class="line"><span class="keyword">using</span> System.Threading;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">ServiceFabric.DataProtection.Web</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">internal</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title">Program</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">Main</span>(<span class="params"><span class="keyword">string</span>[] args</span>)</span><br><span class="line">        </span>&#123;</span><br><span class="line">            <span class="keyword">var</span> parser = <span class="keyword">new</span> Parser(with =&gt; </span><br><span class="line">            &#123;</span><br><span class="line">                with.EnableDashDash = <span class="literal">true</span>;</span><br><span class="line">                with.HelpWriter = Console.Out;</span><br><span class="line">            &#125;);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">var</span> result = parser.ParseArguments&lt;Options&gt;(args);</span><br><span class="line"></span><br><span class="line">            result.MapResult(options =&gt;</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">switch</span> (options.Host.ToLower())</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="keyword">case</span> <span class="string">"servicefabric-weblistener"</span>:</span><br><span class="line">                        &#123;</span><br><span class="line">                            ServiceRuntime.RegisterServiceAsync(<span class="string">"WebServiceType"</span>, context =&gt; <span class="keyword">new</span> WebService(context, ServerType.WebListener)).GetAwaiter().GetResult();</span><br><span class="line">                            Thread.Sleep(Timeout.Infinite);</span><br><span class="line">                            <span class="keyword">break</span>;</span><br><span class="line">                        &#125;</span><br><span class="line">                    <span class="keyword">case</span> <span class="string">"servicefabric-kestrel"</span>:</span><br><span class="line">                        &#123;</span><br><span class="line">                            ServiceRuntime.RegisterServiceAsync(<span class="string">"WebServiceType"</span>, context =&gt; <span class="keyword">new</span> WebService(context, ServerType.Kestrel)).GetAwaiter().GetResult();</span><br><span class="line">                            Thread.Sleep(Timeout.Infinite);</span><br><span class="line">                            <span class="keyword">break</span>;</span><br><span class="line">                        &#125;</span><br><span class="line">                    <span class="keyword">case</span> <span class="string">"weblistener"</span>:</span><br><span class="line">                        &#123;</span><br><span class="line">                            <span class="keyword">using</span> (<span class="keyword">var</span> host = WebHostBuilderHelper.GetWebHost(options.Protocol, options.Port, ServerType.WebListener))</span><br><span class="line">                            &#123;</span><br><span class="line">                                host.Run();</span><br><span class="line">                            &#125;</span><br><span class="line">                            <span class="keyword">break</span>;</span><br><span class="line">                        &#125;</span><br><span class="line">                    <span class="keyword">case</span> <span class="string">"kestrel"</span>:</span><br><span class="line">                        &#123;</span><br><span class="line">                            <span class="keyword">using</span> (<span class="keyword">var</span> host = WebHostBuilderHelper.GetWebHost(options.Protocol, options.Port, ServerType.Kestrel))</span><br><span class="line">                            &#123;</span><br><span class="line">                                host.Run();</span><br><span class="line">                            &#125;</span><br><span class="line">                            <span class="keyword">break</span>;</span><br><span class="line">                        &#125;</span><br><span class="line">                    <span class="keyword">default</span>:</span><br><span class="line">                        <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">            &#125;,</span><br><span class="line">            errors =&gt;</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">internal</span> <span class="keyword">sealed</span> <span class="keyword">class</span> <span class="title">Options</span></span><br><span class="line">    &#123;</span><br><span class="line">        [Option(Default = <span class="string">"weblistener"</span>, HelpText = <span class="string">"Host - Options [weblistener] or [kestrel] or [servicefabric-weblistener] or [servicefabric-kestrel]"</span>)]</span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">string</span> Host &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line"></span><br><span class="line">        [Option(Default = <span class="string">"http"</span>, HelpText = <span class="string">"Protocol - Options [http] or [https]"</span>)]</span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">string</span> Protocol &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line"></span><br><span class="line">        [Option(Default = <span class="string">"localhost"</span>, HelpText = <span class="string">"IP Address or Uri - Example [localhost] or [127.0.0.1]"</span>)]</span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">string</span> IpAddressOrFQDN &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line"></span><br><span class="line">        [Option(Default = <span class="string">"5000"</span>, HelpText = <span class="string">"Port - Example [80] or [5000]"</span>)]</span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">string</span> Port &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>And finally PersistKeysToServiceFabric needs to be added to Startup.cs as this will instruct the ASP.NET Core data protection stack to use our custom AspNetCore.DataProtection.ServiceFabric key repository:</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> Microsoft.AspNetCore.Builder;</span><br><span class="line"><span class="keyword">using</span> Microsoft.AspNetCore.DataProtection;</span><br><span class="line"><span class="keyword">using</span> Microsoft.AspNetCore.Hosting;</span><br><span class="line"><span class="keyword">using</span> Microsoft.Extensions.Configuration;</span><br><span class="line"><span class="keyword">using</span> Microsoft.Extensions.DependencyInjection;</span><br><span class="line"><span class="keyword">using</span> Microsoft.Extensions.Logging;</span><br><span class="line"><span class="keyword">using</span> Swashbuckle.AspNetCore.Swagger;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">ServiceFabric.DataProtection.Web</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">Startup</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">Startup</span>(<span class="params">IHostingEnvironment env</span>)</span><br><span class="line">        </span>&#123;</span><br><span class="line">            <span class="keyword">var</span> builder = <span class="keyword">new</span> ConfigurationBuilder()</span><br><span class="line">                .SetBasePath(env.ContentRootPath)</span><br><span class="line">                .AddJsonFile(<span class="string">"appsettings.json"</span>, optional: <span class="literal">true</span>, reloadOnChange: <span class="literal">true</span>)</span><br><span class="line">                .AddJsonFile(<span class="string">$"appsettings.<span class="subst">&#123;env.EnvironmentName&#125;</span>.json"</span>, optional: <span class="literal">true</span>)</span><br><span class="line">                .AddEnvironmentVariables();</span><br><span class="line">            Configuration = builder.Build();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> IConfigurationRoot Configuration &#123; <span class="keyword">get</span>; &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// This method gets called by the runtime. Use this method to add services to the container.</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">ConfigureServices</span>(<span class="params">IServiceCollection services</span>)</span><br><span class="line">        </span>&#123;</span><br><span class="line">            <span class="comment">// Add framework services.</span></span><br><span class="line">            services.AddMvc();</span><br><span class="line"></span><br><span class="line">            <span class="comment">// Add Service Fabric DataProtection</span></span><br><span class="line">            services.AddDataProtection()</span><br><span class="line">                    .SetApplicationName(<span class="string">"ServiceFabric-DataProtection-Web"</span>)</span><br><span class="line">                    .PersistKeysToServiceFabric();</span><br><span class="line"></span><br><span class="line">            services.AddSwaggerGen(c =&gt;</span><br><span class="line">            &#123;</span><br><span class="line">                c.SwaggerDoc(<span class="string">"v1"</span>, <span class="keyword">new</span> Info &#123; Title = <span class="string">"AspNetCore.DataProtection.ServiceFabric API"</span>, Version = <span class="string">"v1"</span> &#125;);</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// This method gets called by the runtime. Use this method to configure the HTTP request pipeline.</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">Configure</span>(<span class="params">IApplicationBuilder app, IHostingEnvironment env, ILoggerFactory loggerFactory</span>)</span><br><span class="line">        </span>&#123;</span><br><span class="line">            app.UseMvc();</span><br><span class="line">            app.UseSwaggerUi(c =&gt;</span><br><span class="line">            &#123;</span><br><span class="line">                c.SwaggerEndpoint(<span class="string">"/swagger/v1/swagger.json"</span>, <span class="string">"AspNetCore.DataProtection.ServiceFabric API v1"</span>);</span><br><span class="line">            &#125;);</span><br><span class="line">            app.UseSwagger();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>All that is now left to do is within your .Net Core Web Application PackageRoot, edit the ServiceManifest.xml CodePackage so that we tell Web.exe to “host” within Service Fabric using WebListener:</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">CodePackage</span> <span class="attr">Name</span>=<span class="string">"Code"</span> <span class="attr">Version</span>=<span class="string">"1.0.0"</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">EntryPoint</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">ExeHost</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">Program</span>&gt;</span>ServiceFabric.DataProtection.Web.exe<span class="tag">&lt;/<span class="name">Program</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">Arguments</span>&gt;</span>--host servicefabric-weblistener<span class="tag">&lt;/<span class="name">Arguments</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">WorkingFolder</span>&gt;</span>CodePackage<span class="tag">&lt;/<span class="name">WorkingFolder</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">ConsoleRedirection</span> <span class="attr">FileRetentionCount</span>=<span class="string">"5"</span> <span class="attr">FileMaxSizeInKb</span>=<span class="string">"2048"</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">ExeHost</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">EntryPoint</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">CodePackage</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>At an administrative command prompt you’ll need to issue the below command to create the correct Url ACL for port 80 (please refer to the WebListener references section below for detailed instructions):</p>
<p><code>netsh http add urlacl url=http://+:80/ user=Users</code></p>
<p>Upon successful deployment to a multi-node cluster, use Swagger and the Protect/Unprotect APIs to test that all nodes have access to the same data protection keys:</p>
<p><img src="/images/007_AspNetCoreDataProtectionServiceFabricSwaggerAPI.jpg" alt="ASP.Net Core DataProtection ServiceFabric Swagger API"></p>
<p><code>Note, as we&#39;ve created a custom ASP.NET Core data protection key repository, the data protection system will deregister the default key encryption at rest mechanism that the heuristic provided, so keys will no longer be encrypted at rest. It is strongly recommended that you additionally <a href="https://docs.microsoft.com/en-us/aspnet/core/security/data-protection/implementation/key-encryption-at-rest#data-protection-implementation-key-encryption-at-rest-providers" target="_blank" rel="external">specify an explicit key encryption mechanism</a> for production applications.</code></p>
<hr>
<h4 id="References"><a href="#References" class="headerlink" title="References"></a>References</h4><ol>
<li><a href="https://msdn.microsoft.com/en-us/library/ff649308.aspx#paght000007_webfarmdeploymentconsiderations" target="_blank" rel="external">https://msdn.microsoft.com/en-us/library/ff649308.aspx#paght000007_webfarmdeploymentconsiderations</a></li>
<li><a href="https://docs.microsoft.com/en-us/aspnet/core/security/data-protection/introduction" target="_blank" rel="external">https://docs.microsoft.com/en-us/aspnet/core/security/data-protection/introduction</a></li>
<li><a href="https://docs.microsoft.com/en-us/aspnet/core/security/data-protection/implementation/key-storage-providers" target="_blank" rel="external">https://docs.microsoft.com/en-us/aspnet/core/security/data-protection/implementation/key-storage-providers</a></li>
<li><a href="https://docs.microsoft.com/en-us/azure/service-fabric/service-fabric-reliable-services-reliable-collections" target="_blank" rel="external">https://docs.microsoft.com/en-us/azure/service-fabric/service-fabric-reliable-services-reliable-collections</a></li>
<li><a href="https://docs.microsoft.com/en-us/aspnet/core/fundamentals/servers/weblistener" target="_blank" rel="external">https://docs.microsoft.com/en-us/aspnet/core/fundamentals/servers/weblistener</a></li>
<li><a href="https://docs.microsoft.com/en-us/aspnet/core/fundamentals/servers/kestrel" target="_blank" rel="external">https://docs.microsoft.com/en-us/aspnet/core/fundamentals/servers/kestrel</a></li>
</ol>

      
    </div>
    
    
      <footer class="article-footer">
        
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Asp-Net-Core/">Asp.Net Core</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Security/">Security</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Service-Fabric/">Service Fabric</a></li></ul>

      </footer>
    
  </div>
  
    
<nav id="article-nav">
  
  
    <a href="/2016/08/12/Application-Insights-and-Semantic-Logging-for-Service-Fabric-Microservices/" id="article-nav-older" class="article-nav-link-wrap">
      <div class="article-nav-title">Application Insights &amp; Semantic Logging for Service Fabric Microservices&nbsp;<span>&gt;</span></div>
    </a>
  
</nav>

  
</article>

</section>
    <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2017 Medic Consulting&nbsp;
    </div>
  </div>
</footer>
    

<script src="/js/jquery.min.js"></script>


  <link rel="stylesheet" href="/fancybox/jquery.fancybox.css">
  <script src="/fancybox/jquery.fancybox.pack.js"></script>


<script src="/js/script.js"></script>
  </div>
</body>
</html>