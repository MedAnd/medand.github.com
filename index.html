<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <title>Medic Consulting</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description">
<meta property="og:type" content="website">
<meta property="og:title" content="Medic Consulting">
<meta property="og:url" content="http://www.medic-consulting.com/index.html">
<meta property="og:site_name" content="Medic Consulting">
<meta property="og:description">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Medic Consulting">
<meta name="twitter:description">
  
  
    <link rel="icon" href="/favicon.png">
  
  <link href="/webfonts/ptserif/main.css" rel='stylesheet' type='text/css'>
  <link href="/webfonts/source-code-pro/main.css" rel="stylesheet" type="text/css">
  <link href="http://maxcdn.bootstrapcdn.com/font-awesome/latest/css/font-awesome.min.css" rel="stylesheet" type="text/css">
  <link rel="stylesheet" href="/css/style.css">
  
<!-- Google Analytics -->
<script type="text/javascript">
(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','//www.google-analytics.com/analytics.js','ga');

ga('create', 'UA-56342083-1', 'auto');
ga('send', 'pageview');

</script>
<!-- End Google Analytics -->


</head>

<body>
  <div id="container">
    <header id="header">
  <div id="header-outer" class="outer">
    <div id="header-inner" class="inner">
      <a id="main-nav-toggle" class="nav-icon" href="javascript:;"></a>
      <a id="logo" class="logo" href="/"></a>
      <nav id="main-nav">
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
          <a class="main-nav-link" href="/tags">Tags</a>
        
          <a class="main-nav-link" href="/about">About</a>
        
          <a id="social-nav" href="https://www.linkedin.com/profile/view?id=AAEAAADJd3wBQV-OhfBUuu3GZdhCZ8oa_9g462M"><i class="fa fa-linkedin-square" aria-hidden="true"></i></a>
          <a id="social-nav" href="https://github.com/medand"><i class="fa fa-github" aria-hidden="true"></i></a>
          <a id="social-nav" href="/atom.xml"><i class="fa fa-rss" aria-hidden="true"></i></a>
      </nav>
      <nav id="sub-nav">
        <div id="search-form-wrap">
          <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" results="0" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="http://www.medic-consulting.com"></form>
        </div>
      </nav>
    </div>
  </div>
</header>
    <section id="main" class="outer">
      <article id="post-Asp-Net-Core-MVC-6-OpenIdConnect-JWT-and-Angular-2-SPA-Part-2" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2016/06/14/Asp-Net-Core-MVC-6-OpenIdConnect-JWT-and-Angular-2-SPA-Part-2/">Asp.Net Core RC2, OpenIdConnect, JWT, Swagger, AutoRest and Angular 2 SPA - Part 2</a>
    </h1>
  

      </header>
    
    <div class="article-meta">
      <a href="/2016/06/14/Asp-Net-Core-MVC-6-OpenIdConnect-JWT-and-Angular-2-SPA-Part-2/" class="article-date">
  <time datetime="2016-06-13T15:52:00.000Z" itemprop="datePublished">2016-06-14</time>
</a>
      
      
    </div>
    <div class="article-entry" itemprop="articleBody">
      
        <p>Continuing on from a previous post this article details my journey in upgrading a Service Fabric multi-tenant application from .Net Core RC1 to RC2, which turned out to be a breaking albeit worthwhile change, specifically for the Startup.cs class and related boot strapping code for Swagger, CookieAuthentication, OpenIdConnectAuthentication and JwtBearerAuthentication. In subsequent posts we’ll explore how .Net Core RC2 hosts web applications but for now let’s look at the first challenge encountered during the upgrade, which was to chase down all required libraries that are also .Net Core RC2 compatible.</p>
<blockquote><p>As of the time of writing, I could only get Swashbuckle version 6.0.0-beta9 to work with .Net Core RC2. </p>
<p>The below code supports multi-tenant Azure AD authentication and is meant for development scenarios as ValidateIssuer and RequireHttpsMetadata are both set to false for simplicity.</p>
</blockquote>
<p>The full dependencies section of your project.json should look something like this:</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">"dependencies": &#123;</span><br><span class="line">    "Microsoft.AspNetCore.Hosting": "1.0.0-rc2-final",</span><br><span class="line">    "Microsoft.AspNetCore.Authentication": "1.0.0-rc2-final",</span><br><span class="line">    "Microsoft.AspNetCore.Authentication.Cookies": "1.0.0-rc2-final",</span><br><span class="line">    "Microsoft.AspNetCore.Authentication.JwtBearer": "1.0.0-rc2-final",</span><br><span class="line">    "Microsoft.AspNetCore.Authentication.OpenIdConnect": "1.0.0-rc2-final",</span><br><span class="line">    "Microsoft.AspNetCore.Diagnostics": "1.0.0-rc2-final",</span><br><span class="line">    "Microsoft.AspNetCore.SpaServices": "1.0.0-beta-000004",</span><br><span class="line">    "Microsoft.AspNetCore.StaticFiles": "1.0.0-rc2-final",</span><br><span class="line">    "Microsoft.AspNetCore.Mvc.Core": "1.0.0-rc2-final",</span><br><span class="line">    "Microsoft.AspNetCore.Mvc.Formatters.Json": "1.0.0-rc2-final",</span><br><span class="line">    "Microsoft.AspNetCore.Server.Kestrel": "1.0.0-rc2-final",</span><br><span class="line">    "Microsoft.Extensions.Configuration.EnvironmentVariables": "1.0.0-rc2-final",</span><br><span class="line">    "Microsoft.Extensions.Configuration.FileExtensions": "1.0.0-rc2-final",</span><br><span class="line">    "Microsoft.Extensions.Configuration.Json": "1.0.0-rc2-final",</span><br><span class="line">    "Microsoft.IdentityModel.Clients.ActiveDirectory": "3.9.302261508-alpha",</span><br><span class="line">    "Microsoft.Extensions.Configuration.Binder": "1.0.0-rc2-final",</span><br><span class="line">    "Swashbuckle": "6.0.0-beta9",</span><br><span class="line">    "Swashbuckle.SwaggerUi": "6.0.0-beta9",</span><br><span class="line">    "Swashbuckle.SwaggerGen": "6.0.0-beta9"</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Your Startup.cs usings should look something like the below:</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> Microsoft.AspNetCore.Authentication.Cookies;</span><br><span class="line"><span class="keyword">using</span> Microsoft.AspNetCore.Authentication.JwtBearer;</span><br><span class="line"><span class="keyword">using</span> Microsoft.AspNetCore.Authentication.OpenIdConnect;</span><br><span class="line"><span class="keyword">using</span> Microsoft.AspNetCore.Builder;</span><br><span class="line"><span class="keyword">using</span> Microsoft.AspNetCore.Hosting;</span><br><span class="line"><span class="keyword">using</span> Microsoft.AspNetCore.Http;</span><br><span class="line"><span class="keyword">using</span> Microsoft.Extensions.Configuration;</span><br><span class="line"><span class="keyword">using</span> Microsoft.Extensions.DependencyInjection;</span><br><span class="line"><span class="keyword">using</span> Microsoft.Extensions.Logging;</span><br><span class="line"><span class="keyword">using</span> Microsoft.IdentityModel.Tokens;</span><br><span class="line"><span class="keyword">using</span> Newtonsoft.Json.Serialization;</span><br><span class="line"><span class="keyword">using</span> System;</span><br><span class="line"><span class="keyword">using</span> System.Net;</span><br></pre></td></tr></table></figure>
<p>Having sourced the relevant libraries and compatible versions, it’s now time to turn our attention to the ConfigureServices method wherein we’ll setup Swagger, tweak Json formatting for JavaScript clients such as our Angular 2 SPA, and finally also tweak how AutoRest generates client code. I want AutoRest to generate separate files per server side controller which is achieved through a custom SwaggerOperationNameFilter.</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> IServiceProvider <span class="title">ConfigureServices</span>(<span class="params">IServiceCollection services</span>)</span><br><span class="line"></span>&#123;</span><br><span class="line">	<span class="comment">// Add MVC service</span></span><br><span class="line">	services.AddMvc().AddJsonOptions(options =&gt;</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="comment">// Support for JavaScript clients which assume CamelCase - starting with lower case</span></span><br><span class="line">		options.SerializerSettings.ContractResolver = <span class="keyword">new</span> CamelCasePropertyNamesContractResolver();</span><br><span class="line">	&#125;);</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Add Swagger API service</span></span><br><span class="line">	services.AddSwaggerGen();</span><br><span class="line">	services.ConfigureSwaggerGen(options =&gt;</span><br><span class="line">	&#123;</span><br><span class="line">		options.SingleApiVersion(<span class="keyword">new</span> Swashbuckle.SwaggerGen.Generator.Info</span><br><span class="line">		&#123;</span><br><span class="line">			Version = <span class="string">"v1"</span>,</span><br><span class="line">			Title = <span class="string">"Acme API"</span>,</span><br><span class="line">			Description = <span class="string">"Acme API Home"</span>,</span><br><span class="line">			TermsOfService = <span class="string">"Legal"</span></span><br><span class="line">		&#125;);</span><br><span class="line"></span><br><span class="line">		<span class="comment">// Controls how tools like AutoRest generate client code (separate files per server side controller)</span></span><br><span class="line">		options.OperationFilter&lt;SwaggerOperationNameFilter&gt;();</span><br><span class="line">		options.DescribeStringEnumsInCamelCase();</span><br><span class="line">		options.DescribeAllEnumsAsStrings();</span><br><span class="line">	&#125;);</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Configure IoC service</span></span><br><span class="line">	<span class="keyword">var</span> builder = <span class="keyword">new</span> ContainerBuilder();</span><br><span class="line">	builder.Populate(services);</span><br><span class="line">	<span class="keyword">var</span> container = builder.Build();</span><br><span class="line">	<span class="keyword">return</span> container.Resolve&lt;IServiceProvider&gt;();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Code for the custom SwaggerOperationNameFilter:</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">internal</span> <span class="keyword">class</span> <span class="title">SwaggerOperationNameFilter</span> : <span class="title">IOperationFilter</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">Apply</span>(<span class="params">Operation operation, OperationFilterContext context</span>)</span><br><span class="line">	</span>&#123;</span><br><span class="line">		operation.OperationId = context.ApiDescription.GroupName + <span class="string">"_"</span> + operation.OperationId;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Concluding the changes required for the .Net Core RC2 upgrade, we dive into the Configure method. Canny readers will notice that UseCookieAuthentication, UseOpenIdConnectAuthentication and UseJwtBearerAuthentication have been refactored to handle options in a more consistent manner with the rest of the .Net Core APIs. </p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">Configure</span>(<span class="params">IApplicationBuilder app, IHostingEnvironment env, ILoggerFactory loggerFactory</span>)</span><br><span class="line"></span>&#123;	</span><br><span class="line">	<span class="keyword">if</span> (env.IsDevelopment())</span><br><span class="line">	&#123;</span><br><span class="line">		app.UseDeveloperExceptionPage();</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	app.UseStaticFiles();</span><br><span class="line"></span><br><span class="line">	app.UseCookieAuthentication(<span class="keyword">new</span> CookieAuthenticationOptions</span><br><span class="line">	&#123;</span><br><span class="line">		AuthenticationScheme = CookieAuthenticationDefaults.AuthenticationScheme,</span><br><span class="line">		AutomaticAuthenticate = <span class="literal">true</span>,</span><br><span class="line">		AutomaticChallenge = <span class="literal">true</span>,</span><br><span class="line">		CookieSecure = CookieSecureOption.Never,</span><br><span class="line">		<span class="comment">// The default setting for cookie expiration is 14 days. SlidingExpiration is set to true by default</span></span><br><span class="line">		ExpireTimeSpan = TimeSpan.FromHours(<span class="number">1</span>),</span><br><span class="line">		SlidingExpiration = <span class="literal">true</span></span><br><span class="line">	&#125;);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">var</span> acmeOptions = app.ApplicationServices.GetService&lt;AcmeOptions&gt;();</span><br><span class="line"></span><br><span class="line">	app.UseOpenIdConnectAuthentication(<span class="keyword">new</span> OpenIdConnectOptions</span><br><span class="line">	&#123;</span><br><span class="line">		AutomaticAuthenticate = <span class="literal">true</span>,</span><br><span class="line">		AutomaticChallenge = <span class="literal">true</span>,</span><br><span class="line">		ClientId = acmeOptions.ClientId,</span><br><span class="line">		Authority = AcmeConstants.AuthEndpointPrefix + <span class="string">"common/"</span>,</span><br><span class="line">		PostLogoutRedirectUri = acmeOptions.PostLogoutRedirectUri,</span><br><span class="line">		CallbackPath = AcmeRouteConstants.LoginCallbackRoute,</span><br><span class="line">		SignInScheme = CookieAuthenticationDefaults.AuthenticationScheme,</span><br><span class="line">		AuthenticationScheme = OpenIdConnectDefaults.AuthenticationScheme,</span><br><span class="line">		TokenValidationParameters = <span class="keyword">new</span> TokenValidationParameters &#123; ValidateIssuer = <span class="literal">false</span> &#125;,</span><br><span class="line">		RequireHttpsMetadata = <span class="literal">false</span>,</span><br><span class="line">		Events = <span class="keyword">new</span> OpenIdConnectAuthenticationEvents(acmeOptions)</span><br><span class="line">		&#123;</span><br><span class="line">			OnAuthenticationFailed = context =&gt; OpenIdConnectAuthenticationEvents.GetFailedResponse(context)</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;);</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Add JwtBearerAuthentication middleware </span></span><br><span class="line">	app.UseJwtBearerAuthentication(<span class="keyword">new</span> JwtBearerOptions</span><br><span class="line">	&#123;</span><br><span class="line">		AuthenticationScheme = JwtBearerDefaults.AuthenticationScheme,</span><br><span class="line">		Audience = acmeOptions.JwtAudience,</span><br><span class="line">		AutomaticAuthenticate = <span class="literal">true</span>,</span><br><span class="line">		AutomaticChallenge = <span class="literal">true</span>,</span><br><span class="line">		Authority = AcmeConstants.AuthEndpointPrefix + <span class="string">"common/"</span>,</span><br><span class="line">		TokenValidationParameters = <span class="keyword">new</span> TokenValidationParameters</span><br><span class="line">		&#123;</span><br><span class="line">			ValidateIssuer = <span class="literal">false</span>,</span><br><span class="line">		&#125;,</span><br><span class="line">		RequireHttpsMetadata = <span class="literal">false</span>,</span><br><span class="line">		Events = <span class="keyword">new</span> JwtBearerAuthenticationEvents(acmeOptions)</span><br><span class="line">		&#123;</span><br><span class="line">			OnAuthenticationFailed = context =&gt; JwtBearerAuthenticationEvents.GetFailedResponse(context)</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;);</span><br><span class="line"></span><br><span class="line">	app.UseMvc(routes =&gt;</span><br><span class="line">	&#123;</span><br><span class="line">		routes.MapRoute(</span><br><span class="line">			name: <span class="string">"webapi"</span>,</span><br><span class="line">			template: <span class="string">"api/&#123;controller&#125;/&#123;action&#125;/&#123;id?&#125;"</span>);</span><br><span class="line"></span><br><span class="line">		routes.MapSpaFallbackRoute(<span class="string">"spa-fallback"</span>, <span class="keyword">new</span> &#123; controller = <span class="string">"Home"</span>, action = <span class="string">"Index"</span> &#125;);</span><br><span class="line">	&#125;);</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Enable Use of Swagger</span></span><br><span class="line">	app.UseSwaggerGen();</span><br><span class="line">	app.UseSwaggerUi();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>If you’re wondering why I left the Microsoft.IdentityModel.Clients.ActiveDirectory library at “3.9.302261508-alpha”, in upcoming posts we’ll detail a strategy for automated integration testing of your .Net Core APIs using xUnit and optionally a BDD approach (SpecFlow), but more on that topic soon…</p>

      
    </div>
    
    
      <footer class="article-footer">
        
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Asp-Net-Core/">Asp.Net Core</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Security/">Security</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Service-Fabric/">Service Fabric</a></li></ul>

      </footer>
    
  </div>
  
</article>


    
      <article id="post-Visual-Studio-Online-Powershell-steps-snippets" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2016/06/04/Visual-Studio-Online-Powershell-steps-snippets/">Visual Studio Online build step task snippets</a>
    </h1>
  

      </header>
    
    <div class="article-meta">
      <a href="/2016/06/04/Visual-Studio-Online-Powershell-steps-snippets/" class="article-date">
  <time datetime="2016-06-03T14:00:00.000Z" itemprop="datePublished">2016-06-04</time>
</a>
      
      
    </div>
    <div class="article-entry" itemprop="articleBody">
      
        <p>Visual Studio Online build definitions &amp; tasks have certainly come a long way since the old xaml template days. There is even a <a href="https://marketplace.visualstudio.com/vsts/" target="_blank" rel="external">VSO extensions</a> market place. For my current project we are using good old PowerShell based tasks which work together to continuously deploy the solution from VSO to a single node Azure VM Service Fabric cluster which runs all unit, integration and automated UI tests. Some PowerShell snippets which I’ve found helpful along the way are detailed below.</p>
<p>The following task snippet is used to check that a Service Fabric hosted Web endpoint is reachable and ready for integration and UI testing:</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$statuscode</span> = <span class="number">0</span></span><br><span class="line"><span class="keyword">while</span>(<span class="variable">$statuscode</span> <span class="nomarkup">-ne</span> <span class="number">200</span>)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">try</span> </span><br><span class="line">    &#123;</span><br><span class="line">        <span class="variable">$statuscode</span> = (Invoke-WebRequest -Uri <span class="string">"http://localhost"</span>).statuscode</span><br><span class="line">    &#125; </span><br><span class="line">    <span class="keyword">catch</span> </span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">Write-Host</span> <span class="string">"$(Get-Date) ....http://localhost is unreachable, sleeping for 30sec"</span></span><br><span class="line">        <span class="built_in">Start-Sleep</span> -s <span class="number">30</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="built_in">Write-Host</span> <span class="string">"$(Get-Date) ....http://localhost is now reachable, continuing"</span></span><br></pre></td></tr></table></figure>
<p>Logs the content of a test settings xml file and filters out any keys containing the string “Secret”:</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[xml]<span class="variable">$testSettings</span> = <span class="built_in">Get-Content</span> -Path <span class="variable">$args</span>[<span class="number">0</span>]</span><br><span class="line"><span class="variable">$testSettings</span>.configuration.appSettings.add | <span class="built_in">Where-Object</span> &#123;<span class="variable">$_</span>.key <span class="nomarkup">-notmatch</span> <span class="string">"Secret"</span>&#125;</span><br></pre></td></tr></table></figure>
<p>For xUnit tests the provided Visual Studio Test step can be configured with multiple target assemblies separated by a “;” character and wherever possible enable Run In Parallel. Also note to be careful not to end the line with a “;” character as VSO will think there is a missing assembly! For example:</p>
<p>Execution Options &gt;&gt; Test Assembly</p>
<p><code>$(Build.SourcesDirectory)\test\AcmeCore.Test\bin\$(BuildConfiguration)\AcmeCore.Test.dll;</code><br><code>$(Build.SourcesDirectory)\test\AcmeCommon.Test\bin\$(BuildConfiguration)\AcmeCommon.Test.dll</code></p>
<p>Advanced Execution Options &gt;&gt; Path to Custom Test Adapters</p>
<p><code>$(Build.SourcesDirectory)\packages\xunit.runner.visualstudio.2.2.0-beta1-build1144\build\_common\xunit.runner.visualstudio.testadapter.dll</code></p>

      
    </div>
    
    
      <footer class="article-footer">
        
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/PowerShell/">PowerShell</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Service-Fabric/">Service Fabric</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Visual-Studio-Online/">Visual Studio Online</a></li></ul>

      </footer>
    
  </div>
  
</article>


    
      <article id="post-Asp-Net-Core-bug-within-AuthenticationFailed-middleware-on-redirect" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2016/03/29/Asp-Net-Core-bug-within-AuthenticationFailed-middleware-on-redirect/">Asp.Net Core RC1, OpenIdConnect, JWT and Angular 2 SPA - Part 1</a>
    </h1>
  

      </header>
    
    <div class="article-meta">
      <a href="/2016/03/29/Asp-Net-Core-bug-within-AuthenticationFailed-middleware-on-redirect/" class="article-date">
  <time datetime="2016-03-28T13:00:00.000Z" itemprop="datePublished">2016-03-29</time>
</a>
      
      
    </div>
    <div class="article-entry" itemprop="articleBody">
      
        <p>Working with Asp.Net Core and Angular 2 at the time of writing may feel like a trail blazing experience, especially given the lack of documentation and stability in the underling frameworks, libraries and tools, leading to lost time in debugging and searching for answers. </p>
<p>In the hope of documenting some of my own recent experiences integrating these technologies and Microsoft’s micro-services framework <a href="https://azure.microsoft.com/en-us/services/service-fabric/" target="_blank" rel="external">Service Fabric</a>, I’ll dive into specific code areas which have proven fiddley. To start off I should preface that the version of Asp.Net Core I’m currently targeting is RC1 and some bugs and workarounds will not apply to subsequent framework versions. Moreover the Service Fabric version targeted is Service Fabric SDK (version 2.0.217) and Service Fabric Runtime (version 5.0.217).</p>
<p>To begin, we’ll start by configuring CookieAuthentication, OpenIdConnectAuthentication, JwtBearerAuthentication, Mvc &amp; SPA routes in our Asp.Net Core Web project Startup.cs file. </p>
<blockquote><p>Note that the below code supports multi-tenant Azure AD authentication and is meant for development scenarios as ValidateIssuer and RequireHttpsMetadata are both set to false for simplicity.</p>
</blockquote>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">Configure</span>(<span class="params">IApplicationBuilder app, IHostingEnvironment env, ILoggerFactory loggerFactory</span>)</span><br><span class="line"></span>&#123;</span><br><span class="line">	<span class="keyword">if</span> (env.IsDevelopment())</span><br><span class="line">	&#123;</span><br><span class="line">		app.UseBrowserLink();</span><br><span class="line">		app.UseDeveloperExceptionPage();</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	app.UseIISPlatformHandler();</span><br><span class="line">	app.UseStaticFiles();</span><br><span class="line"></span><br><span class="line">	app.UseCookieAuthentication(options =&gt;</span><br><span class="line">	&#123;</span><br><span class="line">		options.AuthenticationScheme = CookieAuthenticationDefaults.AuthenticationScheme;</span><br><span class="line">		options.AutomaticAuthenticate = <span class="literal">true</span>;</span><br><span class="line">		options.AutomaticChallenge = <span class="literal">true</span>;</span><br><span class="line">		options.CookieSecure = CookieSecureOption.Never;</span><br><span class="line">		<span class="comment">// The default setting for cookie expiration is 14 days. SlidingExpiration is set to true by default</span></span><br><span class="line">		options.ExpireTimeSpan = TimeSpan.FromHours(<span class="number">1</span>);</span><br><span class="line">		options.SlidingExpiration = <span class="literal">true</span>;</span><br><span class="line">	&#125;);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">var</span> acmeOptions = app.ApplicationServices.GetService&lt;IOptions&lt;AcmeOptions&gt;&gt;().Value;</span><br><span class="line"></span><br><span class="line">	app.UseOpenIdConnectAuthentication(options =&gt;</span><br><span class="line">	&#123;</span><br><span class="line">		options.AutomaticAuthenticate = <span class="literal">true</span>;</span><br><span class="line">		options.AutomaticChallenge = <span class="literal">true</span>;</span><br><span class="line">		options.ClientId = acmeOptions.AzureAd.ClientId;</span><br><span class="line">		options.Authority = AcmeConstants.AuthEndpointPrefix + <span class="string">"common/"</span>;</span><br><span class="line">		options.PostLogoutRedirectUri = acmeOptions.AzureAd.PostLogoutRedirectUri;</span><br><span class="line">		options.CallbackPath = AcmeRouteConstants.LoginCallbackRoute;</span><br><span class="line">		options.SignInScheme = CookieAuthenticationDefaults.AuthenticationScheme;</span><br><span class="line">		options.AuthenticationScheme = OpenIdConnectDefaults.AuthenticationScheme;</span><br><span class="line">		options.TokenValidationParameters = <span class="keyword">new</span> TokenValidationParameters &#123; ValidateIssuer = <span class="literal">false</span> &#125;;</span><br><span class="line">		options.RequireHttpsMetadata = <span class="literal">false</span>;</span><br><span class="line">		options.Events = <span class="keyword">new</span> OpenIdConnectAuthenticationEvents(acmeOptions.AzureAd)</span><br><span class="line">		&#123;</span><br><span class="line">			OnAuthenticationFailed = context =&gt; OpenIdConnectAuthenticationEvents.GetFailedResponse(context)</span><br><span class="line">		&#125;;</span><br><span class="line">	&#125;);</span><br><span class="line"></span><br><span class="line">	app.UseJwtBearerAuthentication(options =&gt;</span><br><span class="line">	&#123;</span><br><span class="line">		options.AuthenticationScheme = JwtBearerDefaults.AuthenticationScheme;</span><br><span class="line">		options.Audience = acmeOptions.AzureAd.JwtAudience;</span><br><span class="line">		options.AutomaticAuthenticate = <span class="literal">true</span>;</span><br><span class="line">		options.AutomaticChallenge = <span class="literal">true</span>;</span><br><span class="line">		options.Authority = AcmeConstants.Security.AuthEndpointPrefix + <span class="string">"common/"</span>;</span><br><span class="line">		options.TokenValidationParameters = <span class="keyword">new</span> TokenValidationParameters</span><br><span class="line">		&#123;			</span><br><span class="line">			ValidateIssuer = <span class="literal">false</span>,</span><br><span class="line">		&#125;;</span><br><span class="line">		options.RequireHttpsMetadata = <span class="literal">false</span>;</span><br><span class="line">		options.Events = <span class="keyword">new</span> JwtBearerAuthenticationEvents</span><br><span class="line">		&#123;</span><br><span class="line">			OnAuthenticationFailed = context =&gt; JwtBearerAuthenticationEvents.GetFailedResponse(context)</span><br><span class="line">		&#125;;</span><br><span class="line">	&#125;);</span><br><span class="line"></span><br><span class="line">	app.UseMvc(routes =&gt;</span><br><span class="line">	&#123;</span><br><span class="line">		routes.MapRoute(</span><br><span class="line">			name: <span class="string">"webapi"</span>,</span><br><span class="line">			template: <span class="string">"api/&#123;controller&#125;/&#123;action&#125;/&#123;id?&#125;"</span>);</span><br><span class="line"></span><br><span class="line">		routes.MapSpaFallbackRoute(<span class="string">"spa-fallback"</span>, <span class="keyword">new</span> &#123; controller = <span class="string">"Home"</span>, action = <span class="string">"Index"</span> &#125;);</span><br><span class="line">	&#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Apart from both Jwt and OpenIdConnect support, of interest is the implementation of custom event overrides via the OpenIdConnectAuthenticationEvents and JwtBearerAuthenticationEvents classes. As OnAuthenticationFailed cannot be overridden within the derived event classes we wire up our custom logic as below:</p>
<p><code>OnAuthenticationFailed = context =&gt; OpenIdConnectAuthenticationEvents.GetFailedResponse(context)</code></p>
<p><code>OnAuthenticationFailed = context =&gt; JwtBearerAuthenticationEvents.GetFailedResponse(context)</code></p>
<p>In Part 2 we’ll upgrade our code to Asp.Net Core RC2 and add support for Swagger and AutoRest.</p>

      
    </div>
    
    
      <footer class="article-footer">
        
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Asp-Net-Core/">Asp.Net Core</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Security/">Security</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Service-Fabric/">Service Fabric</a></li></ul>

      </footer>
    
  </div>
  
</article>


    
      <article id="post-Continuous-integration-deployment-of-Azure-Web-Roles-using-TFS-on-premise-and-WebDeploy-Part-1" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2014/12/15/Continuous-integration-deployment-of-Azure-Web-Roles-using-TFS-on-premise-and-WebDeploy-Part-1/"> Continuous integration &amp; deployment of Azure Web Roles using TFS on-premise and WebDeploy - Part 1</a>
    </h1>
  

      </header>
    
    <div class="article-meta">
      <a href="/2014/12/15/Continuous-integration-deployment-of-Azure-Web-Roles-using-TFS-on-premise-and-WebDeploy-Part-1/" class="article-date">
  <time datetime="2014-12-14T13:00:00.000Z" itemprop="datePublished">2014-12-15</time>
</a>
      
      
    </div>
    <div class="article-entry" itemprop="articleBody">
      
        <p>Much work has gone into making continuous integration &amp; deployment of Azure Websites as simple and low friction as possible with support for Visual Studio Online, Git and BitBucket etc. For customers and teams still using TFS on-premise and working with Web Roles (Azure Cloud Services) the experience is a little more involved with many resorting to rolling their own solutions, TFS Build Templates and PowerShell scripts, if tools like Octopus Deploy and platforms like appveyor are beyond reach.</p>
<blockquote><p>Before we proceed a small caveat, in part one we’ll look at automating just the deployment of files and code which have changed. This should suffice for most single instance Dev and Test scenarios, where code is compiled and deployed on hourly, daily cycles. For Production you will also want to deploy the .cspkg file in case Azure reprovisions your Web Role instance(s).</p>
</blockquote>
<p>I’ll assume you already have knowledge of the TFS build process, in addition to having source and build TFS server environments configured, I’ll skip straight to the MSBuild parameters as this is where most of the magic happens. I’ll also assume you have the latest Azure SDK and Visual Studio files installed on your build server. By VS files I mean the files required by the BuildProcessTemplate, in my case a customised version of the DefaultTemplate.11.xaml. </p>
<p>PowerShell scripts could be used for the Cloud Service provisioning step however for simplicity I’ve opted for a manual step where I use the Microsoft Azure Publish Settings wizard in VS 2013 and do an initial once off deployment of my Web Role to Azure, making sure to enable Remote Desktop for all roles and Enable Web Deploy for all Web Roles. You will need to take note of the username and password created during this process as they are used later as MSBuild arguments.</p>
<p>Once you have successfully Published your Web Role to an Azure Staging Slot, you will need to repeat the process for the Production Slot, so that we can use the Swap Deployment Slots feature (endpoints have to match) once our tests have passed.</p>
<p>To create a new Dev build definition in Team Explorer I select my preferred Source Setting, Build Defaults, Trigger values, Build Template etc. Note in the MSBuild arguments below UserName and Password are values you defined when using the Microsoft Azure Publish Settings wizard in VS 2013. Moreover I am targeting a Debug build, specifying the VisualStudioVersion which for VS 2013 happens to be 12.0. The MsDeployServiceUrl will always be in the form <a href="https://xyz.cloudapp.net:8172/MSDeploy.axd" target="_blank" rel="external">https://xyz.cloudapp.net:8172/MSDeploy.axd</a> where xyz is either your Cloud Service name or the ID Azure generates for your Staging Web Role.</p>
<p>If you are unsure what this value needs to be go to Server Explorer and drill down the Azure Cloud Services until you find your Staging environment. Selecting the Staging node right click Properties: you will see the value for Name is in the form of a GUID. Use this value and replace xyz. To find your DeployIisAppPath value expand the Staging Node, expand the Web Role and select Instance 0, right click Properties: you will see a Name value in the form Contoso.Web_IN_0. Use this value as your DeployIisAppPath.</p>
<p>So putting it all together, your MSBuild arguments should look something like the following:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">/P:VisualStudioVersion=12.0 </span><br><span class="line">/P:Configuration=Debug </span><br><span class="line">/P:DeployOnBuild=True </span><br><span class="line">/P:DeployTarget=MSDeployPublish </span><br><span class="line">/P:MsDeployServiceUrl=<span class="string">"https://8f5c8aa194524f18bd2697675025fdab.cloudapp.net:8172/MSDeploy.axd"</span></span><br><span class="line">/P:DeployIisAppPath=<span class="string">"Contoso.Web_IN_0_Web"</span> </span><br><span class="line">/P:AllowUntrustedCertificate=True </span><br><span class="line">/P:MSDeployPublishMethod=WMsvc </span><br><span class="line">/P:CreatePackageOnPublish=True </span><br><span class="line">/P:UserName=<span class="string">"contosomasteruser"</span> </span><br><span class="line">/P:Password=<span class="string">"YourPasswordGoesHere"</span></span><br></pre></td></tr></table></figure>

      
    </div>
    
    
      <footer class="article-footer">
        
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Azure/">Azure</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/DevOps/">DevOps</a></li></ul>

      </footer>
    
  </div>
  
</article>


    
      <article id="post-SQL-Server-2014-Availability-Groups-Failover-Identity-column-behaviour" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2014/12/15/SQL-Server-2014-Availability-Groups-Failover-Identity-column-behaviour/"> SQL Server 2014 Availability Groups, Failover &amp; Identity column behaviour</a>
    </h1>
  

      </header>
    
    <div class="article-meta">
      <a href="/2014/12/15/SQL-Server-2014-Availability-Groups-Failover-Identity-column-behaviour/" class="article-date">
  <time datetime="2014-12-14T13:00:00.000Z" itemprop="datePublished">2014-12-15</time>
</a>
      
      
    </div>
    <div class="article-entry" itemprop="articleBody">
      
        <p>Many of us have been using SQL Server’s built-in Identity value feature for as long as we can remember but when running SQL Server in HA scenarios such as AlwaysOn Availability Groups, there are a couple of things to take into consideration.</p>
<p>According to MSDN documentation “Consecutive values after server restart or other failures – SQL Server might cache identity values for performance reasons and some of the assigned values can be lost during a database failure or server restart. This can result in gaps in the identity value upon insert. If gaps are not acceptable then the application should use its own mechanism to generate key values. Using a sequence generator with the NOCACHE option can limit the gaps to transactions that are never committed.”</p>
<p>Moreover we read elsewhere “when a table with less than 1000 rows that has an identity value is part of a database that is failed over in an AlwaysOn availability group, the identity is reseeded to 1000. If the identity value is already over 1000, no reseed occurs. This also occurs if you restart the server.”</p>
<p>For existing Applications using Sequence might not be an option. In this case a scarcely documented workaround might be to set a Start-up Parameter on the SQL Server Service: <strong>-t272.</strong> </p>
<p>The lowercase “t” is an internal trace flag that is used by SQL Server support engineers. </p>

      
    </div>
    
    
      <footer class="article-footer">
        
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/SQL-Server/">SQL Server</a></li></ul>

      </footer>
    
  </div>
  
</article>


    
      <article id="post-Uploading-an-Image-in-MVC-5-to-Azure-Blob-Storage" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2014/11/15/Uploading-an-Image-in-MVC-5-to-Azure-Blob-Storage/"> Uploading an Image in MVC 5 to Azure Blob Storage</a>
    </h1>
  

      </header>
    
    <div class="article-meta">
      <a href="/2014/11/15/Uploading-an-Image-in-MVC-5-to-Azure-Blob-Storage/" class="article-date">
  <time datetime="2014-11-14T13:00:00.000Z" itemprop="datePublished">2014-11-15</time>
</a>
      
      
    </div>
    <div class="article-entry" itemprop="articleBody">
      
        <p>An interesting customer requirement last week came up where I needed to upload an image in MVC 5 directly to Azure Blob Storage. A simplified version follows, removing some application specific logic and validation steps. To start off I first created a MVC model for image upload purposes.</p>
<p>ImageUploadBindingModel</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">ImageUploadBindingModel</span></span><br><span class="line">&#123;</span><br><span class="line">    [MaxFileSize(<span class="number">1000000</span>, ErrorMessage = <span class="string">"Maximum allowed file size is 1MB"</span>)]</span><br><span class="line">    [DataType(DataType.Upload)]</span><br><span class="line">    <span class="keyword">public</span> HttpPostedFileBase DisplayImageUpload &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>For additional validation control over the upload, create a custom ValidationAttribute called MaxFileSizeAttribute.</p>
<p>MaxFileSizeAttribute</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">public class MaxFileSizeAttribute : ValidationAttribute, IClientValidatable</span><br><span class="line">&#123;</span><br><span class="line">    private readonly int _maxFileSize;</span><br><span class="line">    </span><br><span class="line">    public MaxFileSizeAttribute(int maxFileSize)</span><br><span class="line">    &#123;</span><br><span class="line">        _maxFileSize = maxFileSize;</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    public override bool IsValid(object value)</span><br><span class="line">    &#123;</span><br><span class="line">        var file = value as HttpPostedFileBase;</span><br><span class="line">        if (file == null)</span><br><span class="line">        &#123;</span><br><span class="line">            return false;</span><br><span class="line">        &#125;</span><br><span class="line">        return file.ContentLength &lt;= _maxFileSize;</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    public override string FormatErrorMessage(string name)</span><br><span class="line">    &#123;</span><br><span class="line">        return base.FormatErrorMessage(_maxFileSize.ToString());</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    public IEnumerable GetClientValidationRules(ModelMetadata metadata, ControllerContext context)</span><br><span class="line">    &#123;</span><br><span class="line">        var rule = new ModelClientValidationRule</span><br><span class="line">        &#123;</span><br><span class="line">            ErrorMessage = FormatErrorMessage(_maxFileSize.ToString()),</span><br><span class="line">            ValidationType = "filesize"</span><br><span class="line">        &#125;;</span><br><span class="line"> </span><br><span class="line">        rule.ValidationParameters["maxsize"] = _maxFileSize;</span><br><span class="line">        yield return rule;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Now let’s turn our attention to the actual Azure logic which streams the upload direct from MVC memory to Azure Blob Storage. Note that CloudConfigurationManager is used to source relevant connection information required by the Azure libraries, something I hope to cover in another post as it’s a very relevant topic for Cloud first .Net solutions.</p>
<p>AzureStorage.cs</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> Microsoft.WindowsAzure;</span><br><span class="line"><span class="keyword">using</span> Microsoft.WindowsAzure.Storage;</span><br><span class="line"><span class="keyword">using</span> Microsoft.WindowsAzure.Storage.Auth;</span><br><span class="line"><span class="keyword">using</span> Microsoft.WindowsAzure.Storage.Blob;</span><br><span class="line"> </span><br><span class="line"><span class="keyword">namespace</span> <span class="title">Contoso.Helpers</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">AzureStorage</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">UploadFromStream</span>(<span class="params"><span class="keyword">string</span> uniqueBlobName, <span class="keyword">string</span> blobContentType, Stream fileStream</span>)</span><br><span class="line">        </span>&#123;</span><br><span class="line">            <span class="comment">// Retrieve storage account from connection string</span></span><br><span class="line">            CloudStorageAccount storageAccount = CloudStorageAccount.Parse(CloudConfigurationManager.GetSetting(<span class="string">"StorageConnection"</span>));</span><br><span class="line">            <span class="comment">// Create the blob client</span></span><br><span class="line">            CloudBlobClient blobClient = storageAccount.CreateCloudBlobClient();</span><br><span class="line">            <span class="comment">// Retrieve reference to a previously created container</span></span><br><span class="line">            CloudBlobContainer container = blobClient.GetContainerReference(CloudConfigurationManager.GetSetting(<span class="string">"StorageContainer"</span>));</span><br><span class="line">            <span class="comment">// Retrieve reference to a blob</span></span><br><span class="line">            CloudBlockBlob blockBlob = container.GetBlockBlobReference(uniqueBlobName);</span><br><span class="line">            <span class="comment">// Set Blob ContentType</span></span><br><span class="line">            blockBlob.Properties.ContentType = blobContentType;</span><br><span class="line">            <span class="comment">// Stream fileStream to Blob - Note: Overwrites any existing file</span></span><br><span class="line">            blockBlob.UploadFromStream(fileStream);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Lastly the Controller handling the upload.</p>
<p>UploadImage</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">async</span> Task <span class="title">UploadImage</span>(<span class="params">ImageUploadBindingModel model</span>)</span><br><span class="line"></span>&#123;</span><br><span class="line">    ContosoIdentityUser user = <span class="keyword">await</span> UserManager.FindByIdAsync(User.Identity.GetUserId());</span><br><span class="line"> </span><br><span class="line">    <span class="keyword">if</span> (user == <span class="literal">null</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">             </span><br><span class="line">    <span class="keyword">if</span> (!ModelState.IsValid)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> BadRequest(ModelState);</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="keyword">var</span> validImageTypes = <span class="keyword">new</span> <span class="keyword">string</span>[]</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="string">"image/gif"</span>,</span><br><span class="line">        <span class="string">"image/jpeg"</span>,</span><br><span class="line">        <span class="string">"image/pjpeg"</span>,</span><br><span class="line">        <span class="string">"image/png"</span></span><br><span class="line">    &#125;;</span><br><span class="line"> </span><br><span class="line">    <span class="keyword">if</span> (model.DisplayImageUpload != <span class="literal">null</span> &amp;&amp; model.DisplayImageUpload.ContentLength &gt; <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (!validImageTypes.Contains(model.DisplayImageUpload.ContentType))</span><br><span class="line">        &#123;</span><br><span class="line">            ModelState.AddModelError(<span class="string">"DisplayImageUpload"</span>, <span class="string">"Supported Display Image formats: GIF, JPG or PNG."</span>);</span><br><span class="line">            <span class="keyword">return</span> BadRequest(ModelState);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="keyword">if</span> (model.DisplayImageUpload != <span class="literal">null</span> &amp;&amp; model.DisplayImageUpload.ContentLength &gt; <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">string</span> uniqueBlobName = <span class="keyword">string</span>.Format(<span class="string">"Image_&#123;0&#125;.&#123;1&#125;"</span>, user.Id, Path.GetExtension(model.DisplayImageUpload.FileName));</span><br><span class="line">        <span class="keyword">string</span> blobContentType = model.DisplayImageUpload.ContentType;</span><br><span class="line"> </span><br><span class="line">        AzureStorage.UploadFromStream(uniqueBlobName, blobContentType, model.DisplayImageUpload.InputStream);</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="keyword">return</span> Ok();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
      
    </div>
    
    
      <footer class="article-footer">
        
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Asp-Net/">Asp.Net</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Azure/">Azure</a></li></ul>

      </footer>
    
  </div>
  
</article>


    
      <article id="post-Extending-Asp-Net-Identity-2-0-with-custom-fields" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2014/10/31/Extending-Asp-Net-Identity-2-0-with-custom-fields/">Extending Asp.Net Identity 2.0 with custom fields</a>
    </h1>
  

      </header>
    
    <div class="article-meta">
      <a href="/2014/10/31/Extending-Asp-Net-Identity-2-0-with-custom-fields/" class="article-date">
  <time datetime="2014-10-30T13:00:00.000Z" itemprop="datePublished">2014-10-31</time>
</a>
      
      
    </div>
    <div class="article-entry" itemprop="articleBody">
      
        <p>Recently I needed a quick and low friction way of extending Asp.Net Identity 2.0, tying into the Entity Framework 6 way of working with custom fields and table mappings. To accomplish this first create something similar to a new ContosoIdentityUser which inherits from IdentityUser.</p>
<p>ContosoIdentityUser.cs</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> Microsoft.AspNet.Identity.EntityFramework;</span><br><span class="line"> </span><br><span class="line"><span class="keyword">namespace</span> <span class="title">Contoso.Web</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">ContosoIdentityUser</span> : <span class="title">IdentityUser</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">string</span> FirstName &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">string</span> LastName &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">        <span class="keyword">public</span> DateTime DOB &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">string</span> AddressLine1 &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">string</span> AddressLine2 &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">string</span> Suburb &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">string</span> State &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">string</span> Postcode &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;    </span><br></pre></td></tr></table></figure>
<p>We then likewise create a new ContosoIdentityDbContext which inherits from IdentityDbContext.</p>
<p>ContosoIdentityDbContext.cs</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> System;</span><br><span class="line"><span class="keyword">using</span> System.Collections.Generic;</span><br><span class="line"><span class="keyword">using</span> System.Data.Entity;</span><br><span class="line"><span class="keyword">using</span> System.Linq;</span><br><span class="line"><span class="keyword">using</span> System.Web;</span><br><span class="line"> </span><br><span class="line"><span class="keyword">using</span> Microsoft.AspNet.Identity.EntityFramework;</span><br><span class="line"> </span><br><span class="line"><span class="keyword">namespace</span> <span class="title">Contoso.Web</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">ContosoIdentityDbContext</span> : <span class="title">IdentityDbContext</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">ContosoIdentityDbContext</span>(<span class="params"></span>)</span><br><span class="line">            : <span class="title">base</span>(<span class="params"><span class="string">"DefaultConnection"</span></span>)</span><br><span class="line">        </span>&#123;</span><br><span class="line">        &#125;</span><br><span class="line"> </span><br><span class="line">        <span class="function"><span class="keyword">protected</span> <span class="keyword">override</span> <span class="keyword">void</span> <span class="title">OnModelCreating</span>(<span class="params">DbModelBuilder modelBuilder</span>)</span><br><span class="line">        </span>&#123;</span><br><span class="line">            <span class="keyword">if</span> (modelBuilder == <span class="literal">null</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> ArgumentNullException(<span class="string">"modelBuilder"</span>);</span><br><span class="line">            &#125;</span><br><span class="line"> </span><br><span class="line">            SetIdentityUserModel(modelBuilder);</span><br><span class="line">            <span class="keyword">base</span>.OnModelCreating(modelBuilder);</span><br><span class="line">        &#125;</span><br><span class="line"> </span><br><span class="line">        <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">SetIdentityUserModel</span>(<span class="params">DbModelBuilder modelBuilder</span>)</span><br><span class="line">        </span>&#123;</span><br><span class="line">            modelBuilder.Entity().Property(x =&gt; x.FirstName).HasMaxLength(<span class="number">50</span>).IsRequired();</span><br><span class="line">            modelBuilder.Entity().Property(x =&gt; x.LastName).HasMaxLength(<span class="number">50</span>).IsRequired();</span><br><span class="line">            modelBuilder.Entity().Property(x =&gt; x.DOB).IsRequired();</span><br><span class="line">            modelBuilder.Entity().Property(x =&gt; x.AddressLine1).HasMaxLength(<span class="number">100</span>).IsRequired();</span><br><span class="line">            modelBuilder.Entity().Property(x =&gt; x.AddressLine2).HasMaxLength(<span class="number">100</span>).IsOptional();</span><br><span class="line">            modelBuilder.Entity().Property(x =&gt; x.Suburb).HasMaxLength(<span class="number">50</span>).IsRequired();</span><br><span class="line">            modelBuilder.Entity().Property(x =&gt; x.State).HasMaxLength(<span class="number">3</span>).IsRequired();</span><br><span class="line">            modelBuilder.Entity().Property(x =&gt; x.Postcode).HasMaxLength(<span class="number">4</span>).IsRequired();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;  </span><br></pre></td></tr></table></figure>
<p>Now to stitch it all together in your boot strapper logic, in my case this is within Startup(), just wire up to our newly created extensions:</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> userManager = <span class="keyword">new</span> UserManager(<span class="keyword">new</span> UserStore(<span class="keyword">new</span> ContosoIdentityDbContext()));</span><br><span class="line">UserManagerFactory = () =&gt; userManager;</span><br></pre></td></tr></table></figure>

      
    </div>
    
    
      <footer class="article-footer">
        
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Asp-Net/">Asp.Net</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Security/">Security</a></li></ul>

      </footer>
    
  </div>
  
</article>


    </section>
    <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2016 Medic Consulting&nbsp;
    </div>
  </div>
</footer>
    

<script src="/js/jquery.min.js"></script>


  <link rel="stylesheet" href="/fancybox/jquery.fancybox.css">
  <script src="/fancybox/jquery.fancybox.pack.js"></script>


<script src="/js/script.js"></script>
  </div>
</body>
</html>